<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch | Xie&#39;s Exploration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speakin">
<meta property="og:type" content="article">
<meta property="og:title" content="[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch">
<meta property="og:url" content="http://xmhtest.space/2016/11/13/译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch/index.html">
<meta property="og:site_name" content="Xie's Exploration">
<meta property="og:description" content="This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speakin">
<meta property="og:updated_time" content="2016-11-12T17:35:43.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch">
<meta name="twitter:description" content="This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speakin">
  
    <link rel="alternative" href="/atom.xml" title="Xie&#39;s Exploration" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.png">
  
  <script src="/style.js"></script>
</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/daodao.jpg" class="js-avatar show">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Minghao Xie</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Any idea or discussion is highly welcomed.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">Home</a></li>
	        
				<li><a href="/archives">All</a></li>
	        
				<li><a href="/categories/Tech">Tech</a></li>
	        
				<li><a href="/categories/Sci">Sci</a></li>
	        
				<li><a href="/categories/Others">Others</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/Yetocome" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/61cd864864d3f8a1dee10862c79d4e32" title="zhihu">zhihu</a>
		        
					<a class="mail" target="_blank" href="mailto:xmhooo@vip.qq.com" title="mail">mail</a>
		        
					<a class="twitter" target="_blank" href="https://twitter.com/xmhooo" title="twitter">twitter</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Minghao Xie</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/daodao.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Minghao Xie</h1>
			</hgroup>
			
			<p class="header-subtitle">Any idea or discussion is highly welcomed.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">All</a></li>
		        
					<li><a href="/categories/Tech">Tech</a></li>
		        
					<li><a href="/categories/Sci">Sci</a></li>
		        
					<li><a href="/categories/Others">Others</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Yetocome" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/61cd864864d3f8a1dee10862c79d4e32" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:xmhooo@vip.qq.com" title="mail">mail</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/xmhooo" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [译]Twisted Mail Tutorial: Building an SMTP Client from Scratch
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speaking the SMTP protocol, have it connect to an appropriate mail exchange server, and transmit a message for delivery.  </p>
<p>For the majority of this tutorial, twistd will be used to launch the application. Near the end we will explore other possibilities for starting a Twisted application. Until then, make sure that you have twistd installed and conveniently accessible for use in running each of the example .tac files.  </p>
</blockquote>
<p>教程整理自twitsed的官方文档， <strong>原文有删改</strong> ， <a href="https://twistedmatrix.com/documents/current/mail/tutorial/smtpclient/smtpclient.html" target="_blank" rel="external">原文链接</a> </p>
<p><strong>Caution</strong>：本文较长，建议抽出一段较长的时间边运行代码边读。</p>
<p>因为时间有限，很多细节没有翻译，有时间一定补上( ̀⌄ ́)</p>
<p>主要是通过介绍一些及其简单的客户端应用来让我们理解如何创建并启动一个用SMTP协议的TCP客户端，让它能够连接到合适的邮件交换服务器，并能提交用于转发的信息。<br><a id="more"></a></p>
<h3 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h3><ul>
<li>已经配置安装好python，这里使用的版本是2.7.12（注意现在twisted对python 3 的支持还不完全）</li>
<li>安装好twisted，这里使用的版本是16.5.0</li>
<li>确保电脑上的twistd服务可用（应该会随twisted自动安装）</li>
</ul>
<h3 id="启动SMTP服务器"><a href="#启动SMTP服务器" class="headerlink" title="启动SMTP服务器"></a>启动SMTP服务器</h3><p>将下面的代码保存为 <code>email_server.tac</code> ，运行 <code>sudo twistd -ny emailserver.tac</code> 在本地启动服务器，注意sudo不是必须的，因为电脑限制了25端口的开放，所以必须调用最高权限来启动这段代码，你也可以修改其中的25为其他未占用的端口，但注意也要改动之后的SMTP客户端的代码端口为你修改的端口。</p>
<pre><code># Copyright (c) Twisted Matrix Laboratories.
# See LICENSE for details.

# You can run this module directly with:
#    twistd -ny emailserver.tac

&quot;&quot;&quot;
A toy email server.
&quot;&quot;&quot;
from __future__ import print_function

from zope.interface import implementer

from twisted.internet import defer
from twisted.mail import smtp
from twisted.mail.imap4 import LOGINCredentials, PLAINCredentials

from twisted.cred.checkers import InMemoryUsernamePasswordDatabaseDontUse
from twisted.cred.portal import IRealm
from twisted.cred.portal import Portal



@implementer(smtp.IMessageDelivery)
class ConsoleMessageDelivery:
    def receivedHeader(self, helo, origin, recipients):
        return &quot;Received: ConsoleMessageDelivery&quot;


    def validateFrom(self, helo, origin):
        # All addresses are accepted
        return origin


    def validateTo(self, user):
        # Only messages directed to the &quot;console&quot; user are accepted.
        if user.dest.local == &quot;console&quot;:
            return lambda: ConsoleMessage()
        raise smtp.SMTPBadRcpt(user)



@implementer(smtp.IMessage)
class ConsoleMessage:
    def __init__(self):
        self.lines = []


    def lineReceived(self, line):
        self.lines.append(line)


    def eomReceived(self):
        print(&quot;New message received:&quot;)
        print(&quot;\n&quot;.join(self.lines))
        self.lines = None
        return defer.succeed(None)


    def connectionLost(self):
        # There was an error, throw away the stored lines
        self.lines = None



class ConsoleSMTPFactory(smtp.SMTPFactory):
    protocol = smtp.ESMTP

    def __init__(self, *a, **kw):
        smtp.SMTPFactory.__init__(self, *a, **kw)
        self.delivery = ConsoleMessageDelivery()


    def buildProtocol(self, addr):
        p = smtp.SMTPFactory.buildProtocol(self, addr)
        p.delivery = self.delivery
        p.challengers = {&quot;LOGIN&quot;: LOGINCredentials, &quot;PLAIN&quot;: PLAINCredentials}
        return p



@implementer(IRealm)
class SimpleRealm:
    def requestAvatar(self, avatarId, mind, *interfaces):
        if smtp.IMessageDelivery in interfaces:
            return smtp.IMessageDelivery, ConsoleMessageDelivery(), lambda: None
        raise NotImplementedError()



def main():
    from twisted.application import internet
    from twisted.application import service

    portal = Portal(SimpleRealm())
    checker = InMemoryUsernamePasswordDatabaseDontUse()
    checker.addUser(&quot;guest&quot;, &quot;password&quot;)
    portal.registerChecker(checker)

    a = service.Application(&quot;Console SMTP Server&quot;)
    internet.TCPServer(25, ConsoleSMTPFactory(portal)).setServiceParent(a)

    return a

application = main()
</code></pre><h3 id="第一个SMTP客户端"><a href="#第一个SMTP客户端" class="headerlink" title="第一个SMTP客户端"></a>第一个SMTP客户端</h3><p>可能的话，创建一个 <code>smtpclient-1.tac</code> 为twistd所使用。</p>
<p>源代码：</p>
<pre><code>from twisted.application import service
# The first line of the .tac file imports twisted.application.service , a module
# which contains many of the basic service classes and helper functions available
# in Twisted. In particular, we will be using the Application function to create
# a new application service . An application service simply acts as a central
# object on which to store certain kinds of deployment configuration.

application = service.Application(&quot;SMTP Client Tutorial&quot;)

# The second line of the .tac file creates a new application service and binds
# it to the local name application . twistd requires this local name in each .tac
# file it runs. It uses various pieces of configuration on the object to determine
# its behavior. For example, &quot;SMTP Client Tutorial&quot; will be used as the name of
# the .tap file into which to serialize application state, should it be necessary
# to do so.
</code></pre><p>运行我们的服务器，这里-n代表以非后台形式运行，-y表示在python源文件里读取applicaiton：</p>
<pre><code>❯ twistd -ny smtpclient-1.tac
2016-11-12T16:55:36+0800 [-] Loading smtpclient-1.tac...
2016-11-12T16:55:36+0800 [-] Loaded.
2016-11-12T16:55:37+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T16:55:37+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
</code></pre><p>正如显示的这样，没有什么多余的动作了，用^C 来结束它：</p>
<pre><code>^C2016-11-12T15:42:31+0800 [-] Received SIGINT, shutting down.
2016-11-12T15:42:31+0800 [-] Main loop terminated.
2016-11-12T15:42:31+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] Server Shut Down.
</code></pre><h3 id="第二个SMTP客户端"><a href="#第二个SMTP客户端" class="headerlink" title="第二个SMTP客户端"></a>第二个SMTP客户端</h3><p>第一个客户端并不是十分有趣，它甚至没有建立任何TCP连接，接下来这个 <code>smtpclient-2.tac</code> 会更加接近于那个复杂程度。</p>
<p>源代码：</p>
<pre><code>from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol

# twisted.application.internet is another application service module. It provides
# services for establishing outgoing connections (as well as creating network
# servers, though we are not interested in those parts for the moment).
# twisted.internet.protocol provides base implementations of many of the core
# Twisted concepts, such as factories and protocols .

# The next line of smtpclient-2.tac instantiates a new client factory .

smtpClientFactory = protocol.ClientFactory()
# Client factories are responsible for constructing protocol instances whenever
# connections are established. They may be required to create just one instance,
# or many instances if many different connections are established, or they may
# never be required to create one at all, if no connection ever manages to be
# established.

# Now that we have a client factory, we’ll need to hook it up to the network
# somehow. The next line of smtpclient-2.tac does just that:

smtpClientService = internet.TCPClient(None, None, smtpClientFactory)

# We’ll ignore the first two arguments to internet.TCPClient for the moment and
# instead focus on the third. TCPClient is one of those application service
# classes. It creates TCP connections to a specified address and then uses its
# third argument, a client factory , to get a protocol instance . It then
# associates the TCP connection with the protocol instance and gets out of the way.

smtpClientService.setServiceParent(application)
</code></pre><p>我们来试试运行这个客户端：</p>
<pre><code>❯ twistd -ny smtpclient-2.tac
2016-11-12T16:55:57+0800 [-] Loading smtpclient-2.tac...
2016-11-12T16:55:57+0800 [-] Loaded.
2016-11-12T16:55:58+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T16:55:58+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2016-11-12T16:55:58+0800 [stderr#error] Traceback (most recent call last):
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/bin/twistd&quot;, line 11, in &lt;module&gt;
2016-11-12T16:55:58+0800 [stderr#error]     sys.exit(run())
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/scripts/twistd.py&quot;, line 29, in run
2016-11-12T16:55:58+0800 [stderr#error]     app.run(runApp, ServerOptions)
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/application/app.py&quot;, line 648, in run
2016-11-12T16:55:58+0800 [stderr#error]     runApp(config)
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/scripts/twistd.py&quot;, line 25, in runApp
2016-11-12T16:55:58+0800 [stderr#error]     _SomeApplicationRunner(config).run()
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/application/app.py&quot;, line 383, in run
2016-11-12T16:55:58+0800 [stderr#error]     self.postApplication()
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/scripts/_twistd_unix.py&quot;, line 248, in postApplication
2016-11-12T16:55:58+0800 [stderr#error]     self.startApplication(self.application)
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/scripts/_twistd_unix.py&quot;, line 444, in startApplication
2016-11-12T16:55:58+0800 [stderr#error]     app.startApplication(application, not self.config[&apos;no_save&apos;])
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/application/app.py&quot;, line 664, in startApplication
2016-11-12T16:55:58+0800 [stderr#error]     service.IService(application).startService()
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/application/service.py&quot;, line 283, in startService
2016-11-12T16:55:58+0800 [stderr#error]     service.startService()
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/application/internet.py&quot;, line 177, in startService
2016-11-12T16:55:58+0800 [stderr#error]     self._connection = self._getConnection()
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/application/internet.py&quot;, line 195, in _getConnection
2016-11-12T16:55:58+0800 [stderr#error]     &apos;connect%s&apos; % (self.method,))(*self.args, **self.kwargs)
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/posixbase.py&quot;, line 482, in connectTCP
2016-11-12T16:55:58+0800 [stderr#error]     c = tcp.Connector(host, port, factory, timeout, bindAddress, self)
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 1164, in __init__
2016-11-12T16:55:58+0800 [stderr#error]     if abstract.isIPv6Address(host):
2016-11-12T16:55:58+0800 [stderr#error]   File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/abstract.py&quot;, line 522, in isIPv6Address
2016-11-12T16:55:58+0800 [stderr#error]     if &apos;%&apos; in addr:
2016-11-12T16:55:58+0800 [stderr#error] TypeError: argument of type &apos;NoneType&apos; is not iterable
</code></pre><p>发生了什么？看来我们忽略掉的那两个参数还挺重要的。</p>
<h3 id="第三个SMTP客户端"><a href="#第三个SMTP客户端" class="headerlink" title="第三个SMTP客户端"></a>第三个SMTP客户端</h3><p>我们给前面两个参数填上localhost和25（SMTP知名端口号）。</p>
<pre><code>smtpClientService = internet.TCPClient(&apos;localhost&apos;, 25, smtpClientFactory)
</code></pre><p>再次尝试运行：</p>
<pre><code>❯ twistd -ny smtpclient-3.tac
2016-11-12T18:28:52+0800 [-] Loading smtpclient-3.tac...
2016-11-12T18:28:52+0800 [-] Loaded.
2016-11-12T18:28:52+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T18:28:52+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2016-11-12T18:28:52+0800 [twisted.internet.protocol.ClientFactory#info] Starting factory &lt;twisted.internet.protocol.ClientFactory instance at 0x11087f908&gt;
2016-11-12T18:28:52+0800 [Uninitialized] Unhandled Error
    Traceback (most recent call last):
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/log.py&quot;, line 101, in callWithLogger
        return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/log.py&quot;, line 84, in callWithContext
        return context.call({ILogContext: newCtx}, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/context.py&quot;, line 118, in callWithContext
        return self.currentContext().callWithContext(ctx, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/context.py&quot;, line 81, in callWithContext
        return func(*args,**kw)
    --- &lt;exception caught here&gt; ---
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/selectreactor.py&quot;, line 149, in _doReadOrWrite
        why = getattr(selectable, method)()
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 586, in doConnect
        self._connectDone()
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 600, in _connectDone
        self.protocol = self.connector.buildProtocol(self.getPeer())
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/base.py&quot;, line 1074, in buildProtocol
        return self.factory.buildProtocol(addr)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/protocol.py&quot;, line 131, in buildProtocol
        p = self.protocol()
    exceptions.TypeError: &apos;NoneType&apos; object is not callable

2016-11-12T18:28:52+0800 [twisted.internet.protocol.ClientFactory#info] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0x11087f908&gt;
</code></pre><p>看来还是有问题，不过这一次是因为我们没有明确protocol类给factory用造成的，让我们来看看第四个版本。</p>
<h3 id="第四个SMTP客户端"><a href="#第四个SMTP客户端" class="headerlink" title="第四个SMTP客户端"></a>第四个SMTP客户端</h3><p>因为我们没有给客户端factory的protocol实行设定一个正确的值，我们无法成功运行上一个例子。ClientFactory.buildProtocol是一个负责创建一个protocol实例的方法，我们这里暂且使用protocol的基类来完成修改。</p>
<pre><code>from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol

smtpClientFactory = protocol.ClientFactory()
smtpClientFactory.protocol = protocol.Protocol

smtpClientService = internet.TCPClient(&apos;localhost&apos;, 25, smtpClientFactory)
smtpClientService.setServiceParent(application)
</code></pre><p>再次运行：</p>
<pre><code>❯ twistd -ny smtpclient-4.tac
2016-11-12T18:46:08+0800 [-] Loading smtpclient-4.tac...
2016-11-12T18:46:08+0800 [-] Loaded.
2016-11-12T18:46:08+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T18:46:08+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2016-11-12T18:46:08+0800 [twisted.internet.protocol.ClientFactory#info] Starting factory &lt;twisted.internet.protocol.ClientFactory instance at 0x109a3e908&gt;
^C2016-11-12T18:46:33+0800 [-] Received SIGINT, shutting down.
2016-11-12T18:46:33+0800 [twisted.internet.protocol.ClientFactory#info] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0x109a3e908&gt;
2016-11-12T18:46:33+0800 [-] Main loop terminated.
2016-11-12T18:46:33+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] Server Shut Down.
</code></pre><p>对于传统UNIX网络服务熟悉的人，twisted.internet.protocol其实等价于discard服务——它将永远不会制造任何输出并且丢弃它所有的输入，可以说毫无用处。</p>
<h3 id="第五个SMTP客户端"><a href="#第五个SMTP客户端" class="headerlink" title="第五个SMTP客户端"></a>第五个SMTP客户端</h3><p>在这个例子中，我们将第一次使用Twisted的SMTP协议实现。我们将作出明显的改变，仅仅是将 twisted.internet.protocol.Protocol换成twisted.mail.smtp.ESMTPClient，不用担心ESMTP中的E，它告诉我们只是使用一个更新版本的SMTP协议。虽然Twisted中存在SMTPClient，但是我们没有理由去使用它。</p>
<pre><code>from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol

smtpClientFactory = protocol.ClientFactory()

from twisted.mail import smtp
smtpClientFactory.protocol = smtp.ESMTPClient

smtpClientService = internet.TCPClient(&apos;localhost&apos;, 25, smtpClientFactory)
smtpClientService.setServiceParent(application)
</code></pre><p>运行：</p>
<pre><code>❯ twistd -ny smtpclient-5.tac
2016-11-12T18:53:19+0800 [-] Loading smtpclient-5.tac...
2016-11-12T18:53:19+0800 [-] Loaded.
2016-11-12T18:53:19+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T18:53:19+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2016-11-12T18:53:19+0800 [twisted.internet.protocol.ClientFactory#info] Starting factory &lt;twisted.internet.protocol.ClientFactory instance at 0x110622908&gt;
2016-11-12T18:53:19+0800 [Uninitialized] Unhandled Error
    Traceback (most recent call last):
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/log.py&quot;, line 101, in callWithLogger
        return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/log.py&quot;, line 84, in callWithContext
        return context.call({ILogContext: newCtx}, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/context.py&quot;, line 118, in callWithContext
        return self.currentContext().callWithContext(ctx, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/context.py&quot;, line 81, in callWithContext
        return func(*args,**kw)
    --- &lt;exception caught here&gt; ---
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/selectreactor.py&quot;, line 149, in _doReadOrWrite
        why = getattr(selectable, method)()
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 586, in doConnect
        self._connectDone()
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 600, in _connectDone
        self.protocol = self.connector.buildProtocol(self.getPeer())
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/base.py&quot;, line 1074, in buildProtocol
        return self.factory.buildProtocol(addr)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/protocol.py&quot;, line 131, in buildProtocol
        p = self.protocol()
    exceptions.TypeError: __init__() takes at least 2 arguments (1 given)

2016-11-12T18:53:19+0800 [twisted.internet.protocol.ClientFactory#info] Stopping factory &lt;twisted.internet.protocol.ClientFactory instance at 0x110622908&gt;
</code></pre><p>看来还是有问题，这次的原因在于默认的buildProtocol在实例化protocol时没有参数，但是ESMTPClient想要至少一个参数，在下一个版本里，我们将通过重载buildProtocol函数来解决问题。</p>
<h3 id="第六个SMTP客户端"><a href="#第六个SMTP客户端" class="headerlink" title="第六个SMTP客户端"></a>第六个SMTP客户端</h3><p>代码：</p>
<pre><code>from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol
from twisted.mail import smtp

class SMTPClientFactory(protocol.ClientFactory):
    protocol = smtp.ESMTPClient

    def buildProtocol(self, addr):
        return self.protocol(secret=None, identity=&apos;example.com&apos;)
# The overridden method does almost the same thing as the base implementation:
# the only change is that it passes values for two arguments to
# twisted.mail.smtp.ESMTPClient ‘s initializer. The secret argument is used for
# SMTP authentication (which we will not attempt yet). The identity argument is
# used as a to identify ourselves Another minor change to note is that the
# protocol attribute is now defined in the class definition, rather than tacked
# onto an instance after one is created. This means it is a class attribute,
# rather than an instance attribute, now, which makes no difference as far as
# this example is concerned. There are circumstances in which the difference is
# important: be sure you understand the implications of each approach when
# creating your own factories.

# One other change is required: instead of instantiating 
# twisted.internet.protocol.ClientFactory , we will now instantiate 
# SMTPClientFactory :
smtpClientFactory = SMTPClientFactory()

smtpClientService = internet.TCPClient(&apos;localhost&apos;, 25, smtpClientFactory)
smtpClientService.setServiceParent(application)
</code></pre><p>运行：</p>
<pre><code>❯ twistd -ny smtpclient-6.tac
2016-11-12T19:53:54+0800 [-] Loading smtpclient-6.tac...
2016-11-12T19:53:54+0800 [-] Loaded.
2016-11-12T19:53:54+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T19:53:54+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2016-11-12T19:53:54+0800 [__builtin__.SMTPClientFactory#info] Starting factory &lt;__builtin__.SMTPClientFactory instance at 0x1011ed3b0&gt;
2016-11-12T19:53:54+0800 [ESMTPClient,client] Unhandled Error
    Traceback (most recent call last):
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/log.py&quot;, line 101, in callWithLogger
        return callWithContext({&quot;system&quot;: lp}, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/log.py&quot;, line 84, in callWithContext
        return context.call({ILogContext: newCtx}, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/context.py&quot;, line 118, in callWithContext
        return self.currentContext().callWithContext(ctx, func, *args, **kw)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/python/context.py&quot;, line 81, in callWithContext
        return func(*args,**kw)
    --- &lt;exception caught here&gt; ---
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/selectreactor.py&quot;, line 149, in _doReadOrWrite
        why = getattr(selectable, method)()
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 208, in doRead
        return self._dataReceived(data)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py&quot;, line 214, in _dataReceived
        rval = self.protocol.dataReceived(data)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/protocols/basic.py&quot;, line 571, in dataReceived
        why = self.lineReceived(line)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py&quot;, line 913, in lineReceived
        why = self._okresponse(self.code,&apos;\n&apos;.join(self.resp))
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py&quot;, line 1350, in esmtpState_serverConfig
        self.tryTLS(code, resp, items)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py&quot;, line 1395, in tryTLS
        self.authenticate(code, resp, items)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py&quot;, line 1462, in authenticate
        self.smtpState_from(code, resp)
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py&quot;, line 940, in smtpState_from
        self._from = self.getMailFrom()
      File &quot;/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py&quot;, line 1035, in getMailFrom
        raise NotImplementedError
    exceptions.NotImplementedError: 

2016-11-12T19:53:54+0800 [__builtin__.SMTPClientFactory#info] Stopping factory &lt;__builtin__.SMTPClientFactory instance at 0x1011ed3b0&gt;
</code></pre><blockquote>
<p>What we have accomplished with this iteration of the example is to navigate far enough into an SMTP transaction that Twisted is now interested in calling back to application-level code to determine what its next step should be. In the next example, we’ll see how to provide that information to it.<br>（这句有点长，怕翻译的不到位……）</p>
</blockquote>
<h3 id="第七个SMTP客户端"><a href="#第七个SMTP客户端" class="headerlink" title="第七个SMTP客户端"></a>第七个SMTP客户端</h3><p>这个版本时我们的SMTP客户端第一次真正包括了数据传递。</p>
<p>为了简洁性考虑，信息被定义为新类的一部分。在实际可用于发送邮件的客户端，信息数据可能会从文件系统、数据库，还可能由用户输入中引入。</p>
<p>在这里我们在类里定义了三个属性 <code>(mailFrom , mailTo , and mailData )</code></p>
<pre><code>from __future__ import print_function
import StringIO

from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol
from twisted.mail import smtp

class SMTPTutorialClient(smtp.ESMTPClient):
    mailFrom = &quot;tutorial_sender@example.com&quot;
    mailTo = &quot;tutorial_recipient@example.net&quot;
    mailData = &apos;&apos;&apos;\
Date: Fri, 6 Feb 2004 10:14:39 -0800
From: Tutorial Guy &lt;tutorial_sender@example.com&gt;
To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;
Subject: Tutorate!

Hello, how are you, goodbye.
&apos;&apos;&apos;

    def getMailFrom(self):
        result = self.mailFrom
        self.mailFrom = None
        return result

    def getMailTo(self):
        return [self.mailTo]

    def getMailData(self):
        return StringIO.StringIO(self.mailData)

    def sentMail(self, code, resp, numOk, addresses, log):
        print(&apos;Sent&apos;, numOk, &apos;messages&apos;)

class SMTPClientFactory(protocol.ClientFactory):
    protocol = SMTPTutorialClient

    def buildProtocol(self, addr):
        return self.protocol(secret=None, identity=&apos;example.com&apos;)

smtpClientFactory = SMTPClientFactory()

smtpClientService = internet.TCPClient(&apos;localhost&apos;, 25, smtpClientFactory)
smtpClientService.setServiceParent(application)
</code></pre><p>我们来剖析一下其中的四个函数：</p>
<ul>
<li><code>def getMailFrom(self):</code> 这个方法用于确定 <code>reverse-path</code>  ——也被称作发件地址。这个值被用于SMTP中的 <code>MAIL</code> 命令。这个方法必须返回符合 RFC 2821 定义的一个 <code>reverse-path</code> 。简单的说，就是它可以是i 个像”alice@example.com”这样的字符串。注意只有一个发件地址被SMTP协议所允许；</li>
<li><code>def getMailTo(self):</code> 和上一个方法差不多，返回一个或多个RFC 2821定义的 <code>forward-path</code> —— 转发地址，注意它必须包括至少一个地址，即使只有一个，它也将是一个列表（感觉这里好啰嗦）；</li>
<li><code>def getMailData(self):</code> 这个也很简单，它将会返回一个包含信息内容的文件或者类文件对象。在这里，它将返回一个StringIO因为我们已经有一个包括信息的字符窜了。假使文件内容包括多行（正如邮件通常的样子），行间应该由 <code>\n</code> 来划分（正如我们经常以“rt”模式打开文本文件）：必要的newline会由 <code>SMTPClient</code> 自动转换；</li>
<li><p><code>def sentMail(self, code, resp, numOk, addresses, log):</code> 这个方法和邮件发送没有太大关系，是用给twisted来提供信息传递成功与失败信息的；其中 <code>code</code> 是最终命令返回的状态码：</p>
<blockquote>
<p>For successful transactions, it will be 250. For transient failures (those which should be retried), it will be between 400 and 499, inclusive. For permanent failures (this which will never work, no matter how many times you retry them), it will be between 500 and 599.  </p>
</blockquote>
<p>  ❯ twistd -ny smtpclient-7.tac<br>  2016-11-12T20:06:32+0800 [-] Loading smtpclient-7.tac…<br>  2016-11-12T20:06:32+0800 [-] Loaded.<br>  2016-11-12T20:06:32+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.<br>  2016-11-12T20:06:32+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.<br>  2016-11-12T20:06:32+0800 [<strong>builtin</strong>.SMTPClientFactory#info] Starting factory <__builtin__.smtpclientfactory instance="" at="" 0x10c04fa70=""><br>  2016-11-12T20:06:32+0800 [stdout#info] Sent 0 messages<br>  2016-11-12T20:06:32+0800 [<strong>builtin</strong>.SMTPClientFactory#info] Stopping factory <__builtin__.smtpclientfactory instance="" at="" 0x10c04fa70=""></__builtin__.smtpclientfactory></__builtin__.smtpclientfactory></p>
</li>
</ul>
<h3 id="第八个SMTP客户端"><a href="#第八个SMTP客户端" class="headerlink" title="第八个SMTP客户端"></a>第八个SMTP客户端</h3><p>这个版本就添加了两行代码，避免了每次发送完邮件后都要输入^C 的尴尬……</p>
<pre><code>from __future__ import print_function
import StringIO

from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol
from twisted.mail import smtp

class SMTPTutorialClient(smtp.ESMTPClient):
    mailFrom = &quot;tutorial_sender@example.com&quot;
    # mailTo = &quot;tutorial_recipient@example.net&quot;
    mailTo = &quot;console@example.net&quot;
    mailData = &apos;&apos;&apos;\
Date: Fri, 6 Feb 2004 10:14:39 -0800
From: Tutorial Guy &lt;tutorial_sender@example.com&gt;
To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;
Subject: Tutorate!

Hello, how are you, goodbye.
&apos;&apos;&apos;

    def getMailFrom(self):
        result = self.mailFrom
        self.mailFrom = None
        return result

    def getMailTo(self):
        return [self.mailTo]

    def getMailData(self):
        return StringIO.StringIO(self.mailData)

    def sentMail(self, code, resp, numOk, addresses, log):
        print(&apos;Sent&apos;, numOk, &apos;messages&apos;)

        from twisted.internet import reactor
        reactor.stop()

class SMTPClientFactory(protocol.ClientFactory):
    protocol = SMTPTutorialClient

    def buildProtocol(self, addr):
        return self.protocol(secret=None, identity=&apos;example.com&apos;)

smtpClientFactory = SMTPClientFactory()

smtpClientService = internet.TCPClient(&apos;localhost&apos;, 25, smtpClientFactory)
smtpClientService.setServiceParent(application)
</code></pre><p>stop作为reactor的一个方法，是退出twisted事件循环的重要函数。（关于对twisted异步编程的机制，在过段时间对twisted有了更深入的理解后会总结成一篇博文。）</p>
<p>运行：</p>
<pre><code>❯ twistd -ny smtpclient-8.tac
2016-11-12T20:55:58+0800 [-] Loading smtpclient-8.tac...
2016-11-12T20:55:58+0800 [-] Loaded.
2016-11-12T20:55:58+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.
2016-11-12T20:55:58+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.
2016-11-12T20:55:58+0800 [__builtin__.SMTPClientFactory#info] Starting factory &lt;__builtin__.SMTPClientFactory instance at 0x10213ca70&gt;
2016-11-12T20:55:58+0800 [stdout#info] Sent 0 messages
2016-11-12T20:55:58+0800 [__builtin__.SMTPClientFactory#info] Stopping factory &lt;__builtin__.SMTPClientFactory instance at 0x10213ca70&gt;
2016-11-12T20:55:58+0800 [-] Main loop terminated.
2016-11-12T20:55:58+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] Server Shut Down.
</code></pre><h3 id="第九个SMTP客户端"><a href="#第九个SMTP客户端" class="headerlink" title="第九个SMTP客户端"></a>第九个SMTP客户端</h3><p>还存在一个遗留任务让这个tutorial SMTP变完整：相对总是通过知名主机寄送邮件，我们还会查询邮件交换服务器来寻找收件人的地址并且尝试递交信息给那个主机。</p>
<p>在这个版本，我们先是通过定义一个函数来完成这个特性</p>
<pre><code>def getMailExchange(host):
    return &apos;localhost&apos;
</code></pre><p>很明显这并没有返回正确的邮件交换主机（实际上，它返回我们现在一直使用的主机），但是它给出了决定连接哪个主机的逻辑。我们用它来构造新的TCPClient服务：</p>
<pre><code>smtpClientService = internet.TCPClient(
    getMailExchange(&apos;example.net&apos;), 25, smtpClientFactory)
</code></pre><p>下个版本我们会扩充 <code>getMailExchange</code> 的定义。</p>
<h3 id="第十个SMTP客户端"><a href="#第十个SMTP客户端" class="headerlink" title="第十个SMTP客户端"></a>第十个SMTP客户端</h3><p>对一个特定的域名确定一个邮件交换主机需要包括网络交通（特别的，一些DNS请求）。则可能要花一个非常长的时间，所以我们介绍 <code>Deferred</code> 来表示 <code>getMailExchange</code> 的返回结果，修改函数为：</p>
<pre><code>def getMailExchange(host):
    return defer.succeed(&apos;localhost&apos;)
</code></pre><p><code>defer.succeed</code> 用已经存在的结果创建一个新的 <code>Deferred</code> 对象，现在我需要调整TCPClient来构造能够期望并且恰当处理这个 <code>Deferred</code> 代码。</p>
<pre><code>def cbMailExchange(exchange):
    smtpClientFactory = SMTPClientFactory()

    smtpClientService = internet.TCPClient(exchange, 25, smtpClientFactory)
    smtpClientService.setServiceParent(application)

getMailExchange(&apos;example.net&apos;).addCallback(cbMailExchange)
</code></pre><p>深入了解 <code>Deferred</code> 已经超出了本文档的范畴，访问这里获得更多信息 <a href="https://twistedmatrix.com/documents/current/core/howto/defer.html" target="_blank" rel="external">Deferred Reference — Twisted 16.5.0 documentation</a> </p>
<h3 id="第十一个SMTP客户端"><a href="#第十一个SMTP客户端" class="headerlink" title="第十一个SMTP客户端"></a>第十一个SMTP客户端</h3><p>我们已经准备好对邮件交换的查询。现在我们将defer换成真正的查找函数—— <code>twisted.mail.relaymanager.MXCalculator</code></p>
<pre><code>def getMailExchange(host):
    def cbMX(mxRecord):
        return str(mxRecord.name)
    return relaymanager.MXCalculator().getMX(host).addCallback(cbMX)
</code></pre><p>因为getMX返回Record_MX对象而不是string对象，在返回之前我们再多做一些预处理。现在我们完成了这个tutorial  SMTP客户端，它能够：</p>
<ul>
<li>look up the mail exchange host for the recipient domain</li>
<li>connect to it</li>
<li>complete an SMTP transaction</li>
<li>report its results</li>
<li>finally shut down the reacto</li>
</ul>
<p>最终版本：</p>
<pre><code>from __future__ import print_function
import StringIO

from twisted.application import service

application = service.Application(&quot;SMTP Client Tutorial&quot;)

from twisted.application import internet
from twisted.internet import protocol
from twisted.internet import defer
from twisted.mail import smtp, relaymanager

class SMTPTutorialClient(smtp.ESMTPClient):
    mailFrom = &quot;tutorial_sender@example.com&quot;
    mailTo = &quot;tutorial_recipient@example.net&quot;
    mailData = &apos;&apos;&apos;\
Date: Fri, 6 Feb 2004 10:14:39 -0800
From: Tutorial Guy &lt;tutorial_sender@example.com&gt;
To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;
Subject: Tutorate!

Hello, how are you, goodbye.
&apos;&apos;&apos;

    def getMailFrom(self):
        result = self.mailFrom
        self.mailFrom = None
        return result

    def getMailTo(self):
        return [self.mailTo]

    def getMailData(self):
        return StringIO.StringIO(self.mailData)

    def sentMail(self, code, resp, numOk, addresses, log):
        print(&apos;Sent&apos;, numOk, &apos;messages&apos;)

        from twisted.internet import reactor
        reactor.stop()

class SMTPClientFactory(protocol.ClientFactory):
    protocol = SMTPTutorialClient

    def buildProtocol(self, addr):
        return self.protocol(secret=None, identity=&apos;example.com&apos;)

def getMailExchange(host):
    def cbMX(mxRecord):
        return str(mxRecord.name)
    return relaymanager.MXCalculator().getMX(host).addCallback(cbMX)

def cbMailExchange(exchange):
    smtpClientFactory = SMTPClientFactory()

    smtpClientService = internet.TCPClient(exchange, 25, smtpClientFactory)
    smtpClientService.setServiceParent(application)

getMailExchange(&apos;example.net&apos;).addCallback(cbMailExchange)
</code></pre>
      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/11/13/译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch/" class="archive-article-date">
  	<time datetime="2016-11-12T17:21:12.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-13</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Network/">Network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLDR/">TLDR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/twisted/">twisted</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Tech/">Tech</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
  
    <a href="/2016/09/21/【Mac】Terminal改造小记/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">【Mac】Terminal改造小记</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch" data-title="[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch" data-url="http://xmhtest.space/2016/11/13/译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"xmhtech"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Minghao Xie
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/"
	}
</script>

<script src="/main.js"></script>





<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/AI/" style="font-size: 20px;">AI</a> <a href="/tags/Concurrency/" style="font-size: 10px;">Concurrency</a> <a href="/tags/Google/" style="font-size: 10px;">Google</a> <a href="/tags/Network/" style="font-size: 13.33px;">Network</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/OpenWrt/" style="font-size: 10px;">OpenWrt</a> <a href="/tags/Prolog/" style="font-size: 20px;">Prolog</a> <a href="/tags/Resource/" style="font-size: 13.33px;">Resource</a> <a href="/tags/SDN/" style="font-size: 10px;">SDN</a> <a href="/tags/TLDR/" style="font-size: 10px;">TLDR</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/VM/" style="font-size: 10px;">VM</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/develop/" style="font-size: 13.33px;">develop</a> <a href="/tags/info/" style="font-size: 16.67px;">info</a> <a href="/tags/language/" style="font-size: 20px;">language</a> <a href="/tags/mac/" style="font-size: 13.33px;">mac</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/router/" style="font-size: 10px;">router</a> <a href="/tags/summary/" style="font-size: 10px;">summary</a> <a href="/tags/tool/" style="font-size: 13.33px;">tool</a> <a href="/tags/twisted/" style="font-size: 10px;">twisted</a> <a href="/tags/web/" style="font-size: 10px;">web</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租1</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">四川大学&lt;br&gt;&lt;br&gt;2014级&lt;br&gt;计算机科学专业&lt;br&gt;在读</div>
  	  	
    	</section>
    
  </div>
  
</div>
  </div>
</body>
</html>