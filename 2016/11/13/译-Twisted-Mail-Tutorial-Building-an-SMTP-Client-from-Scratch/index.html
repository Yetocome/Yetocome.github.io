<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch | Xie&#39;s Exploration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speakin">
<meta property="og:type" content="article">
<meta property="og:title" content="[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch">
<meta property="og:url" content="http://xmhtest.space/2016/11/13/译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch/index.html">
<meta property="og:site_name" content="Xie's Exploration">
<meta property="og:description" content="This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speakin">
<meta property="og:updated_time" content="2016-11-12T17:26:48.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch">
<meta name="twitter:description" content="This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speakin">
  
    <link rel="alternative" href="/atom.xml" title="Xie&#39;s Exploration" type="application/atom+xml">
  
  
    <link rel="icon" href="//favicon.png">
  
  <script src="/style.js"></script>
</head>

<body>
  <div id="container">
    <div class="left-col">
      <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img src="/daodao.jpg" class="js-avatar show">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Minghao Xie</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Any idea or discussion is highly welcomed.</p>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">Home</a></li>
	        
				<li><a href="/archives">All</a></li>
	        
				<li><a href="/categories/Tech">Tech</a></li>
	        
				<li><a href="/categories/Sci">Sci</a></li>
	        
				<li><a href="/categories/Others">Others</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
	        
    		
    			
    			<a class="js-smart-menu" data-idx="0" href="javascript:void(0)">所有文章</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="1" href="javascript:void(0)">标签</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="2" href="javascript:void(0)">友链</a>
    			
    			
            
    			
    			<a class="js-smart-menu" data-idx="3" href="javascript:void(0)">关于我</a>
    			
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="https://github.com/Yetocome" title="github">github</a>
		        
					<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/61cd864864d3f8a1dee10862c79d4e32" title="zhihu">zhihu</a>
		        
					<a class="mail" target="_blank" href="mailto:xmhooo@vip.qq.com" title="mail">mail</a>
		        
					<a class="twitter" target="_blank" href="https://twitter.com/xmhooo" title="twitter">twitter</a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"><i class="icon-list"></i></div>
  		<h1 class="header-author js-mobile-header hide">Minghao Xie</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				
					<img src="/daodao.jpg" class="js-avatar">
				
			</div>
			<hgroup>
			  <h1 class="header-author">Minghao Xie</h1>
			</hgroup>
			
			<p class="header-subtitle">Any idea or discussion is highly welcomed.</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">Home</a></li>
		        
					<li><a href="/archives">All</a></li>
		        
					<li><a href="/categories/Tech">Tech</a></li>
		        
					<li><a href="/categories/Sci">Sci</a></li>
		        
					<li><a href="/categories/Others">Others</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Yetocome" title="github">github</a>
			        
						<a class="zhihu" target="_blank" href="http://www.zhihu.com/people/61cd864864d3f8a1dee10862c79d4e32" title="zhihu">zhihu</a>
			        
						<a class="mail" target="_blank" href="mailto:xmhooo@vip.qq.com" title="mail">mail</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/xmhooo" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap">
        <article id="post-译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      [译]Twisted Mail Tutorial: Building an SMTP Client from Scratch
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>This tutorial will walk you through the creation of an extremely simple SMTP client application. By the time the tutorial is complete, you will understand how to create and start a TCP client speaking the SMTP protocol, have it connect to an appropriate mail exchange server, and transmit a message for delivery.  </p>
<p>For the majority of this tutorial, twistd will be used to launch the application. Near the end we will explore other possibilities for starting a Twisted application. Until then, make sure that you have twistd installed and conveniently accessible for use in running each of the example .tac files.  </p>
</blockquote>
<p>教程整理自twitsed的官方文档， <strong>原文有删改</strong> ， <a href="https://twistedmatrix.com/documents/current/mail/tutorial/smtpclient/smtpclient.html" target="_blank" rel="external">原文链接</a> </p>
<p><strong>Caution</strong>：本文较长，建议抽出一段较长的时间边运行代码边读。</p>
<p>因为时间有限，很多细节没有翻译，有时间一定补上( ̀⌄ ́)</p>
<p>主要是通过介绍一些及其简单的客户端应用来让我们理解如何创建并启动一个用SMTP协议的TCP客户端，让它能够连接到合适的邮件交换服务器，并能提交用于转发的信息。<br><a id="more"></a></p>
<h3 id="开始之前"><a href="#开始之前" class="headerlink" title="开始之前"></a>开始之前</h3><ul>
<li>已经配置安装好python，这里使用的版本是2.7.12（注意现在twisted对python 3 的支持还不完全）</li>
<li>安装好twisted，这里使用的版本是16.5.0</li>
<li>确保电脑上的twistd服务可用（应该会随twisted自动安装）</li>
</ul>
<h3 id="启动SMTP服务器"><a href="#启动SMTP服务器" class="headerlink" title="启动SMTP服务器"></a>启动SMTP服务器</h3><p>将下面的代码保存为 <code>email_server.tac</code> ，运行 <code>sudo twistd -ny emailserver.tac</code> 在本地启动服务器，注意sudo不是必须的，因为电脑限制了25端口的开放，所以必须调用最高权限来启动这段代码，你也可以修改其中的25为其他未占用的端口，但注意也要改动之后的SMTP客户端的代码端口为你修改的端口。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Copyright (c) Twisted Matrix Laboratories.</span></div><div class="line"><span class="comment"># See LICENSE for details.</span></div><div class="line"></div><div class="line"><span class="comment"># You can run this module directly with:</span></div><div class="line"><span class="comment">#    twistd -ny emailserver.tac</span></div><div class="line"></div><div class="line"><span class="string">"""</span></div><div class="line">A toy email server.</div><div class="line">"""</div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"></div><div class="line"><span class="keyword">from</span> zope.interface <span class="keyword">import</span> implementer</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> defer</div><div class="line"><span class="keyword">from</span> twisted.mail <span class="keyword">import</span> smtp</div><div class="line"><span class="keyword">from</span> twisted.mail.imap4 <span class="keyword">import</span> LOGINCredentials, PLAINCredentials</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.cred.checkers <span class="keyword">import</span> InMemoryUsernamePasswordDatabaseDontUse</div><div class="line"><span class="keyword">from</span> twisted.cred.portal <span class="keyword">import</span> IRealm</div><div class="line"><span class="keyword">from</span> twisted.cred.portal <span class="keyword">import</span> Portal</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@implementer(smtp.IMessageDelivery)</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsoleMessageDelivery</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receivedHeader</span><span class="params">(self, helo, origin, recipients)</span>:</span></div><div class="line">        <span class="keyword">return</span> <span class="string">"Received: ConsoleMessageDelivery"</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validateFrom</span><span class="params">(self, helo, origin)</span>:</span></div><div class="line">        <span class="comment"># All addresses are accepted</span></div><div class="line">        <span class="keyword">return</span> origin</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validateTo</span><span class="params">(self, user)</span>:</span></div><div class="line">        <span class="comment"># Only messages directed to the "console" user are accepted.</span></div><div class="line">        <span class="keyword">if</span> user.dest.local == <span class="string">"console"</span>:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">lambda</span>: ConsoleMessage()</div><div class="line">        <span class="keyword">raise</span> smtp.SMTPBadRcpt(user)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@implementer(smtp.IMessage)</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsoleMessage</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.lines = []</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">lineReceived</span><span class="params">(self, line)</span>:</span></div><div class="line">        self.lines.append(line)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">eomReceived</span><span class="params">(self)</span>:</span></div><div class="line">        print(<span class="string">"New message received:"</span>)</div><div class="line">        print(<span class="string">"\n"</span>.join(self.lines))</div><div class="line">        self.lines = <span class="keyword">None</span></div><div class="line">        <span class="keyword">return</span> defer.succeed(<span class="keyword">None</span>)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connectionLost</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># There was an error, throw away the stored lines</span></div><div class="line">        self.lines = <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConsoleSMTPFactory</span><span class="params">(smtp.SMTPFactory)</span>:</span></div><div class="line">    protocol = smtp.ESMTP</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, *a, **kw)</span>:</span></div><div class="line">        smtp.SMTPFactory.__init__(self, *a, **kw)</div><div class="line">        self.delivery = ConsoleMessageDelivery()</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></div><div class="line">        p = smtp.SMTPFactory.buildProtocol(self, addr)</div><div class="line">        p.delivery = self.delivery</div><div class="line">        p.challengers = &#123;<span class="string">"LOGIN"</span>: LOGINCredentials, <span class="string">"PLAIN"</span>: PLAINCredentials&#125;</div><div class="line">        <span class="keyword">return</span> p</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@implementer(IRealm)</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleRealm</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">requestAvatar</span><span class="params">(self, avatarId, mind, *interfaces)</span>:</span></div><div class="line">        <span class="keyword">if</span> smtp.IMessageDelivery <span class="keyword">in</span> interfaces:</div><div class="line">            <span class="keyword">return</span> smtp.IMessageDelivery, ConsoleMessageDelivery(), <span class="keyword">lambda</span>: <span class="keyword">None</span></div><div class="line">        <span class="keyword">raise</span> NotImplementedError()</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">from</span> twisted.application <span class="keyword">import</span> internet</div><div class="line">    <span class="keyword">from</span> twisted.application <span class="keyword">import</span> service</div><div class="line"></div><div class="line">    portal = Portal(SimpleRealm())</div><div class="line">    checker = InMemoryUsernamePasswordDatabaseDontUse()</div><div class="line">    checker.addUser(<span class="string">"guest"</span>, <span class="string">"password"</span>)</div><div class="line">    portal.registerChecker(checker)</div><div class="line"></div><div class="line">    a = service.Application(<span class="string">"Console SMTP Server"</span>)</div><div class="line">    internet.TCPServer(<span class="number">25</span>, ConsoleSMTPFactory(portal)).setServiceParent(a)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> a</div><div class="line"></div><div class="line">application = main()</div></pre></td></tr></table></figure>
<h3 id="第一个SMTP客户端"><a href="#第一个SMTP客户端" class="headerlink" title="第一个SMTP客户端"></a>第一个SMTP客户端</h3><p>可能的话，创建一个 <code>smtpclient-1.tac</code> 为twistd所使用。</p>
<p>源代码：</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> twisted.<span class="built_in">application</span> import service</div><div class="line"><span class="comment"># The first line of the .tac file imports twisted.application.service , a module</span></div><div class="line"><span class="comment"># which contains many of the basic service classes and helper functions available</span></div><div class="line"><span class="comment"># in Twisted. In particular, we will be using the Application function to create</span></div><div class="line"><span class="comment"># a new application service . An application service simply acts as a central</span></div><div class="line"><span class="comment"># object on which to store certain kinds of deployment configuration.</span></div><div class="line"></div><div class="line"><span class="built_in">application</span> = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line"><span class="comment"># The second line of the .tac file creates a new application service and binds</span></div><div class="line"><span class="comment"># it to the local name application . twistd requires this local name in each .tac</span></div><div class="line"><span class="comment"># file it runs. It uses various pieces of configuration on the object to determine</span></div><div class="line"><span class="comment"># its behavior. For example, "SMTP Client Tutorial" will be used as the name of</span></div><div class="line"><span class="comment"># the .tap file into which to serialize application state, should it be necessary</span></div><div class="line"><span class="comment"># to do so.</span></div></pre></td></tr></table></figure>
<p>运行我们的服务器，这里-n代表以非后台形式运行，-y表示在python源文件里读取applicaiton：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient<span class="string">-1</span>.tac</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:36<span class="string">+0800</span> [-] Loading smtpclient<span class="string">-1</span>.tac...</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:36<span class="string">+0800</span> [-] Loaded.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:37<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:37<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.</div></pre></td></tr></table></figure>
<p>正如显示的这样，没有什么多余的动作了，用^C 来结束它：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">^<span class="selector-tag">C2016-11-12T15</span><span class="selector-pseudo">:42</span><span class="selector-pseudo">:31+0800</span> <span class="selector-attr">[-]</span> <span class="selector-tag">Received</span> <span class="selector-tag">SIGINT</span>, <span class="selector-tag">shutting</span> <span class="selector-tag">down</span>.</div><div class="line">2016<span class="selector-tag">-11-12T15</span><span class="selector-pseudo">:42</span><span class="selector-pseudo">:31+0800</span> <span class="selector-attr">[-]</span> <span class="selector-tag">Main</span> <span class="selector-tag">loop</span> <span class="selector-tag">terminated</span>.</div><div class="line">2016<span class="selector-tag">-11-12T15</span><span class="selector-pseudo">:42</span><span class="selector-pseudo">:31+0800</span> <span class="selector-attr">[twisted.scripts._twistd_unix.UnixAppLogger#info]</span> <span class="selector-tag">Server</span> <span class="selector-tag">Shut</span> <span class="selector-tag">Down</span>.</div></pre></td></tr></table></figure>
<h3 id="第二个SMTP客户端"><a href="#第二个SMTP客户端" class="headerlink" title="第二个SMTP客户端"></a>第二个SMTP客户端</h3><p>第一个客户端并不是十分有趣，它甚至没有建立任何TCP连接，接下来这个 <code>smtpclient-2.tac</code> 会更加接近于那个复杂程度。</p>
<p>源代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> internet</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> protocol</div><div class="line"></div><div class="line"><span class="comment"># twisted.application.internet is another application service module. It provides</span></div><div class="line"><span class="comment"># services for establishing outgoing connections (as well as creating network</span></div><div class="line"><span class="comment"># servers, though we are not interested in those parts for the moment).</span></div><div class="line"><span class="comment"># twisted.internet.protocol provides base implementations of many of the core</span></div><div class="line"><span class="comment"># Twisted concepts, such as factories and protocols .</span></div><div class="line"></div><div class="line"><span class="comment"># The next line of smtpclient-2.tac instantiates a new client factory .</span></div><div class="line"></div><div class="line">smtpClientFactory = protocol.ClientFactory()</div><div class="line"><span class="comment"># Client factories are responsible for constructing protocol instances whenever</span></div><div class="line"><span class="comment"># connections are established. They may be required to create just one instance,</span></div><div class="line"><span class="comment"># or many instances if many different connections are established, or they may</span></div><div class="line"><span class="comment"># never be required to create one at all, if no connection ever manages to be</span></div><div class="line"><span class="comment"># established.</span></div><div class="line"></div><div class="line"><span class="comment"># Now that we have a client factory, we’ll need to hook it up to the network</span></div><div class="line"><span class="comment"># somehow. The next line of smtpclient-2.tac does just that:</span></div><div class="line"></div><div class="line">smtpClientService = internet.TCPClient(<span class="keyword">None</span>, <span class="keyword">None</span>, smtpClientFactory)</div><div class="line"></div><div class="line"><span class="comment"># We’ll ignore the first two arguments to internet.TCPClient for the moment and</span></div><div class="line"><span class="comment"># instead focus on the third. TCPClient is one of those application service</span></div><div class="line"><span class="comment"># classes. It creates TCP connections to a specified address and then uses its</span></div><div class="line"><span class="comment"># third argument, a client factory , to get a protocol instance . It then</span></div><div class="line"><span class="comment"># associates the TCP connection with the protocol instance and gets out of the way.</span></div><div class="line"></div><div class="line">smtpClientService.setServiceParent(application)</div></pre></td></tr></table></figure>
<p>我们来试试运行这个客户端：</p>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient<span class="string">-2</span>.tac</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:57<span class="string">+0800</span> [-] Loading smtpclient<span class="string">-2</span>.tac...</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:57<span class="string">+0800</span> [-] Loaded.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error] Traceback (most recent call last):</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/bin/twistd", line 11, in &lt;module&gt;</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     sys.exit(run())</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/scripts/twistd.py", line 29, in run</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     app.run(runApp, ServerOptions)</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/application/app.py", line 648, in run</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     runApp(config)</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/scripts/twistd.py", line 25, in runApp</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     _SomeApplicationRunner(config).run()</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/application/app.py", line 383, in run</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     self.postApplication()</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/scripts/_twistd_unix.py", line 248, in postApplication</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     self.startApplication(self.application)</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/scripts/_twistd_unix.py", line 444, in startApplication</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     app.startApplication(application, not self.config['no_save'])</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/application/app.py", line 664, in startApplication</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     service.IService(application).startService()</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/application/service.py", line 283, in startService</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     service.startService()</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/application/internet.py", line 177, in startService</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     self._connection = self._getConnection()</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/application/internet.py", line 195, in _getConnection</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     'connect%s' % (self.method,))(*self.args, **self.kwargs)</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/internet/posixbase.py", line 482, in connectTCP</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     c = tcp.Connector(host, port, factory, timeout, bindAddress, self)</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py", line 1164, in __init__</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     if abstract.isIPv6Address(host):</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]   File "/usr/local/lib/python2.7/site-packages/twisted/internet/abstract.py", line 522, in isIPv6Address</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error]     if '%' in addr:</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T16:55:58<span class="string">+0800</span> [stderr#error] TypeError: argument of type 'NoneType' is not iterable</div></pre></td></tr></table></figure>
<p>发生了什么？看来我们忽略掉的那两个参数还挺重要的。</p>
<h3 id="第三个SMTP客户端"><a href="#第三个SMTP客户端" class="headerlink" title="第三个SMTP客户端"></a>第三个SMTP客户端</h3><p>我们给前面两个参数填上localhost和25（SMTP知名端口号）。</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attr">smtpClientService</span> = internet.TCPClient(<span class="string">'localhost'</span>, <span class="number">25</span>, smtpClientFactory)</div></pre></td></tr></table></figure>
<p>再次尝试运行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient-<span class="number">3</span><span class="selector-class">.tac</span></div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [-] Loading smtpclient-<span class="number">3</span><span class="selector-class">.tac</span>...</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [-] Loaded.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] twistd <span class="number">16.5</span>.<span class="number">0</span> (/usr/local/opt/python/bin/python2.<span class="number">7</span> <span class="number">2.7</span>.<span class="number">12</span>) starting up.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] reactor class: twisted<span class="selector-class">.internet</span><span class="selector-class">.selectreactor</span><span class="selector-class">.SelectReactor</span>.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span>#info] Starting factory &lt;twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span> instance at <span class="number">0</span>x11087f908&gt;</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [Uninitialized] Unhandled Error</div><div class="line">	Traceback (most recent call last):</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/log.py"</span>, line <span class="number">101</span>, <span class="keyword">in</span> callWithLogger</div><div class="line">	    return callWithContext(&#123;<span class="string">"system"</span>: lp&#125;, func, *args, **kw)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/log.py"</span>, line <span class="number">84</span>, <span class="keyword">in</span> callWithContext</div><div class="line">	    return context.call(&#123;ILogContext: newCtx&#125;, func, *args, **kw)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/context.py"</span>, line <span class="number">118</span>, <span class="keyword">in</span> callWithContext</div><div class="line">	    return self.currentContext().callWithContext(ctx, func, *args, **kw)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/context.py"</span>, line <span class="number">81</span>, <span class="keyword">in</span> callWithContext</div><div class="line">	    return func(*args,**kw)</div><div class="line">	--- &lt;exception caught here&gt; ---</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/selectreactor.py"</span>, line <span class="number">149</span>, <span class="keyword">in</span> _doReadOrWrite</div><div class="line">	    why = getattr(selectable, method)()</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py"</span>, line <span class="number">586</span>, <span class="keyword">in</span> doConnect</div><div class="line">	    self._connectDone()</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py"</span>, line <span class="number">600</span>, <span class="keyword">in</span> _connectDone</div><div class="line">	    self<span class="selector-class">.protocol</span> = self<span class="selector-class">.connector</span><span class="selector-class">.buildProtocol</span>(self.getPeer())</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/base.py"</span>, line <span class="number">1074</span>, <span class="keyword">in</span> buildProtocol</div><div class="line">	    return self<span class="selector-class">.factory</span><span class="selector-class">.buildProtocol</span>(addr)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/protocol.py"</span>, line <span class="number">131</span>, <span class="keyword">in</span> buildProtocol</div><div class="line">	    <span class="selector-tag">p</span> = self.protocol()</div><div class="line">	exceptions<span class="selector-class">.TypeError</span>: <span class="string">'NoneType'</span> <span class="selector-tag">object</span> is not callable</div><div class="line">	</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">28</span>:<span class="number">52</span>+<span class="number">0800</span> [twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span>#info] Stopping factory &lt;twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span> instance at <span class="number">0</span>x11087f908&gt;</div></pre></td></tr></table></figure>
<p>看来还是有问题，不过这一次是因为我们没有明确protocol类给factory用造成的，让我们来看看第四个版本。</p>
<h3 id="第四个SMTP客户端"><a href="#第四个SMTP客户端" class="headerlink" title="第四个SMTP客户端"></a>第四个SMTP客户端</h3><p>因为我们没有给客户端factory的protocol实行设定一个正确的值，我们无法成功运行上一个例子。ClientFactory.buildProtocol是一个负责创建一个protocol实例的方法，我们这里暂且使用protocol的基类来完成修改。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">from twisted<span class="selector-class">.application</span> import service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line">from twisted<span class="selector-class">.application</span> import internet</div><div class="line">from twisted<span class="selector-class">.internet</span> import protocol</div><div class="line"></div><div class="line">smtpClientFactory = protocol.ClientFactory()</div><div class="line">smtpClientFactory<span class="selector-class">.protocol</span> = protocol<span class="selector-class">.Protocol</span></div><div class="line"></div><div class="line">smtpClientService = internet.TCPClient(<span class="string">'localhost'</span>, <span class="number">25</span>, smtpClientFactory)</div><div class="line">smtpClientService.setServiceParent(application)</div></pre></td></tr></table></figure>
<p>再次运行：<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient-<span class="number">4</span><span class="selector-class">.tac</span></div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">08</span>+<span class="number">0800</span> [-] Loading smtpclient-<span class="number">4</span><span class="selector-class">.tac</span>...</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">08</span>+<span class="number">0800</span> [-] Loaded.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">08</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] twistd <span class="number">16.5</span>.<span class="number">0</span> (/usr/local/opt/python/bin/python2.<span class="number">7</span> <span class="number">2.7</span>.<span class="number">12</span>) starting up.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">08</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] reactor class: twisted<span class="selector-class">.internet</span><span class="selector-class">.selectreactor</span><span class="selector-class">.SelectReactor</span>.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">08</span>+<span class="number">0800</span> [twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span>#info] Starting factory &lt;twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span> instance at <span class="number">0</span>x109a3e908&gt;</div><div class="line">^C2016-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">33</span>+<span class="number">0800</span> [-] Received SIGINT, shutting down.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">33</span>+<span class="number">0800</span> [twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span>#info] Stopping factory &lt;twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span> instance at <span class="number">0</span>x109a3e908&gt;</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">33</span>+<span class="number">0800</span> [-] Main loop terminated.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">46</span>:<span class="number">33</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] Server Shut Down.</div></pre></td></tr></table></figure></p>
<p>对于传统UNIX网络服务熟悉的人，twisted.internet.protocol其实等价于discard服务——它将永远不会制造任何输出并且丢弃它所有的输入，可以说毫无用处。</p>
<h3 id="第五个SMTP客户端"><a href="#第五个SMTP客户端" class="headerlink" title="第五个SMTP客户端"></a>第五个SMTP客户端</h3><p>在这个例子中，我们将第一次使用Twisted的SMTP协议实现。我们将作出明显的改变，仅仅是将 twisted.internet.protocol.Protocol换成twisted.mail.smtp.ESMTPClient，不用担心ESMTP中的E，它告诉我们只是使用一个更新版本的SMTP协议。虽然Twisted中存在SMTPClient，但是我们没有理由去使用它。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from twisted<span class="selector-class">.application</span> import service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line">from twisted<span class="selector-class">.application</span> import internet</div><div class="line">from twisted<span class="selector-class">.internet</span> import protocol</div><div class="line"></div><div class="line">smtpClientFactory = protocol.ClientFactory()</div><div class="line"></div><div class="line">from twisted<span class="selector-class">.mail</span> import smtp</div><div class="line">smtpClientFactory<span class="selector-class">.protocol</span> = smtp<span class="selector-class">.ESMTPClient</span></div><div class="line"></div><div class="line">smtpClientService = internet.TCPClient(<span class="string">'localhost'</span>, <span class="number">25</span>, smtpClientFactory)</div><div class="line">smtpClientService.setServiceParent(application)</div></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient-<span class="number">5</span><span class="selector-class">.tac</span></div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [-] Loading smtpclient-<span class="number">5</span><span class="selector-class">.tac</span>...</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [-] Loaded.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] twistd <span class="number">16.5</span>.<span class="number">0</span> (/usr/local/opt/python/bin/python2.<span class="number">7</span> <span class="number">2.7</span>.<span class="number">12</span>) starting up.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [twisted<span class="selector-class">.scripts</span>._twistd_unix.UnixAppLogger#info] reactor class: twisted<span class="selector-class">.internet</span><span class="selector-class">.selectreactor</span><span class="selector-class">.SelectReactor</span>.</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span>#info] Starting factory &lt;twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span> instance at <span class="number">0</span>x110622908&gt;</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [Uninitialized] Unhandled Error</div><div class="line">	Traceback (most recent call last):</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/log.py"</span>, line <span class="number">101</span>, <span class="keyword">in</span> callWithLogger</div><div class="line">	    return callWithContext(&#123;<span class="string">"system"</span>: lp&#125;, func, *args, **kw)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/log.py"</span>, line <span class="number">84</span>, <span class="keyword">in</span> callWithContext</div><div class="line">	    return context.call(&#123;ILogContext: newCtx&#125;, func, *args, **kw)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/context.py"</span>, line <span class="number">118</span>, <span class="keyword">in</span> callWithContext</div><div class="line">	    return self.currentContext().callWithContext(ctx, func, *args, **kw)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/context.py"</span>, line <span class="number">81</span>, <span class="keyword">in</span> callWithContext</div><div class="line">	    return func(*args,**kw)</div><div class="line">	--- &lt;exception caught here&gt; ---</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/selectreactor.py"</span>, line <span class="number">149</span>, <span class="keyword">in</span> _doReadOrWrite</div><div class="line">	    why = getattr(selectable, method)()</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py"</span>, line <span class="number">586</span>, <span class="keyword">in</span> doConnect</div><div class="line">	    self._connectDone()</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py"</span>, line <span class="number">600</span>, <span class="keyword">in</span> _connectDone</div><div class="line">	    self<span class="selector-class">.protocol</span> = self<span class="selector-class">.connector</span><span class="selector-class">.buildProtocol</span>(self.getPeer())</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/base.py"</span>, line <span class="number">1074</span>, <span class="keyword">in</span> buildProtocol</div><div class="line">	    return self<span class="selector-class">.factory</span><span class="selector-class">.buildProtocol</span>(addr)</div><div class="line">	  File <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/protocol.py"</span>, line <span class="number">131</span>, <span class="keyword">in</span> buildProtocol</div><div class="line">	    <span class="selector-tag">p</span> = self.protocol()</div><div class="line">	exceptions<span class="selector-class">.TypeError</span>: __init__() takes at least <span class="number">2</span> arguments (<span class="number">1</span> given)</div><div class="line">	</div><div class="line"><span class="number">2016</span>-<span class="number">11</span>-<span class="number">12</span>T18:<span class="number">53</span>:<span class="number">19</span>+<span class="number">0800</span> [twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span>#info] Stopping factory &lt;twisted<span class="selector-class">.internet</span><span class="selector-class">.protocol</span><span class="selector-class">.ClientFactory</span> instance at <span class="number">0</span>x110622908&gt;</div></pre></td></tr></table></figure>
<p>看来还是有问题，这次的原因在于默认的buildProtocol在实例化protocol时没有参数，但是ESMTPClient想要至少一个参数，在下一个版本里，我们将通过重载buildProtocol函数来解决问题。</p>
<h3 id="第六个SMTP客户端"><a href="#第六个SMTP客户端" class="headerlink" title="第六个SMTP客户端"></a>第六个SMTP客户端</h3><p>代码：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> internet</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> protocol</div><div class="line"><span class="keyword">from</span> twisted.mail <span class="keyword">import</span> smtp</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPClientFactory</span><span class="params">(protocol.ClientFactory)</span>:</span></div><div class="line">    protocol = smtp.ESMTPClient</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.protocol(secret=<span class="keyword">None</span>, identity=<span class="string">'example.com'</span>)</div><div class="line"><span class="comment"># The overridden method does almost the same thing as the base implementation:</span></div><div class="line"><span class="comment"># the only change is that it passes values for two arguments to</span></div><div class="line"><span class="comment"># twisted.mail.smtp.ESMTPClient ‘s initializer. The secret argument is used for</span></div><div class="line"><span class="comment"># SMTP authentication (which we will not attempt yet). The identity argument is</span></div><div class="line"><span class="comment"># used as a to identify ourselves Another minor change to note is that the</span></div><div class="line"><span class="comment"># protocol attribute is now defined in the class definition, rather than tacked</span></div><div class="line"><span class="comment"># onto an instance after one is created. This means it is a class attribute,</span></div><div class="line"><span class="comment"># rather than an instance attribute, now, which makes no difference as far as</span></div><div class="line"><span class="comment"># this example is concerned. There are circumstances in which the difference is</span></div><div class="line"><span class="comment"># important: be sure you understand the implications of each approach when</span></div><div class="line"><span class="comment"># creating your own factories.</span></div><div class="line"></div><div class="line"><span class="comment"># One other change is required: instead of instantiating </span></div><div class="line"><span class="comment"># twisted.internet.protocol.ClientFactory , we will now instantiate </span></div><div class="line"><span class="comment"># SMTPClientFactory :</span></div><div class="line">smtpClientFactory = SMTPClientFactory()</div><div class="line"></div><div class="line">smtpClientService = internet.TCPClient(<span class="string">'localhost'</span>, <span class="number">25</span>, smtpClientFactory)</div><div class="line">smtpClientService.setServiceParent(application)</div></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient-6.tac</div><div class="line">2016-11-12T19:53:54+0800 [-] Loading smtpclient-6.tac...</div><div class="line">2016-11-12T19:53:54+0800 [-] Loaded.</div><div class="line">2016-11-12T19:53:54+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/<span class="keyword">local</span>/opt/python/bin/python2.7 2.7.12) starting up.</div><div class="line">2016-11-12T19:53:54+0800 [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor <span class="keyword">class</span>: twisted.internet.selectreactor.SelectReactor.</div><div class="line">2016-11-12T19:53:54+0800 [__builtin__.SMTPClientFactory#info] Starting factory &lt;__builtin__.SMTPClientFactory instance at 0x1011ed3b0&gt;</div><div class="line">2016-11-12T19:53:54+0800 [ESMTPClient,client] Unhandled <span class="keyword">Error</span></div><div class="line">	Traceback (most recent call last):</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/log.py"</span>, <span class="keyword">line</span> 101, <span class="keyword">in</span> callWithLogger</div><div class="line">	    <span class="keyword">return</span> callWithContext(&#123;<span class="string">"system"</span>: lp&#125;, func, *<span class="keyword">args</span>, **kw)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/log.py"</span>, <span class="keyword">line</span> 84, <span class="keyword">in</span> callWithContext</div><div class="line">	    <span class="keyword">return</span> context.call(&#123;ILogContext: newCtx&#125;, func, *<span class="keyword">args</span>, **kw)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/context.py"</span>, <span class="keyword">line</span> 118, <span class="keyword">in</span> callWithContext</div><div class="line">	    <span class="keyword">return</span> self.currentContext().callWithContext(ctx, func, *<span class="keyword">args</span>, **kw)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/python/context.py"</span>, <span class="keyword">line</span> 81, <span class="keyword">in</span> callWithContext</div><div class="line">	    <span class="keyword">return</span> func(*<span class="keyword">args</span>,**kw)</div><div class="line">	--- &lt;exception caught here&gt; ---</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/selectreactor.py"</span>, <span class="keyword">line</span> 149, <span class="keyword">in</span> _doReadOrWrite</div><div class="line">	    why = getattr(selectable, method)()</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py"</span>, <span class="keyword">line</span> 208, <span class="keyword">in</span> doRead</div><div class="line">	    <span class="keyword">return</span> self._dataReceived(data)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/internet/tcp.py"</span>, <span class="keyword">line</span> 214, <span class="keyword">in</span> _dataReceived</div><div class="line">	    rval = self.protocol.dataReceived(data)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/protocols/basic.py"</span>, <span class="keyword">line</span> 571, <span class="keyword">in</span> dataReceived</div><div class="line">	    why = self.lineReceived(<span class="keyword">line</span>)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py"</span>, <span class="keyword">line</span> 913, <span class="keyword">in</span> lineReceived</div><div class="line">	    why = self._okresponse(self.code,'\<span class="keyword">n</span>'.join(self.resp))</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py"</span>, <span class="keyword">line</span> 1350, <span class="keyword">in</span> esmtpState_serverConfig</div><div class="line">	    self.tryTLS(code, resp, items)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py"</span>, <span class="keyword">line</span> 1395, <span class="keyword">in</span> tryTLS</div><div class="line">	    self.authenticate(code, resp, items)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py"</span>, <span class="keyword">line</span> 1462, <span class="keyword">in</span> authenticate</div><div class="line">	    self.smtpState_from(code, resp)</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py"</span>, <span class="keyword">line</span> 940, <span class="keyword">in</span> smtpState_from</div><div class="line">	    self._from = self.getMailFrom()</div><div class="line">	  <span class="keyword">File</span> <span class="string">"/usr/local/lib/python2.7/site-packages/twisted/mail/smtp.py"</span>, <span class="keyword">line</span> 1035, <span class="keyword">in</span> getMailFrom</div><div class="line">	    raise NotImplementedError</div><div class="line">	exceptions.NotImplementedError: </div><div class="line">	</div><div class="line">2016-11-12T19:53:54+0800 [__builtin__.SMTPClientFactory#info] Stopping factory &lt;__builtin__.SMTPClientFactory instance at 0x1011ed3b0&gt;</div></pre></td></tr></table></figure>
<blockquote>
<p>What we have accomplished with this iteration of the example is to navigate far enough into an SMTP transaction that Twisted is now interested in calling back to application-level code to determine what its next step should be. In the next example, we’ll see how to provide that information to it.<br>（这句有点长，怕翻译的不到位……）</p>
</blockquote>
<h3 id="第七个SMTP客户端"><a href="#第七个SMTP客户端" class="headerlink" title="第七个SMTP客户端"></a>第七个SMTP客户端</h3><p>这个版本时我们的SMTP客户端第一次真正包括了数据传递。</p>
<p>为了简洁性考虑，信息被定义为新类的一部分。在实际可用于发送邮件的客户端，信息数据可能会从文件系统、数据库，还可能由用户输入中引入。</p>
<p>在这里我们在类里定义了三个属性 <code>(mailFrom , mailTo , and mailData )</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><span class="keyword">import</span> StringIO</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> internet</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> protocol</div><div class="line"><span class="keyword">from</span> twisted.mail <span class="keyword">import</span> smtp</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPTutorialClient</span><span class="params">(smtp.ESMTPClient)</span>:</span></div><div class="line">    mailFrom = <span class="string">"tutorial_sender@example.com"</span></div><div class="line">    mailTo = <span class="string">"tutorial_recipient@example.net"</span></div><div class="line">    mailData = <span class="string">'''\</span></div><div class="line">Date: Fri, 6 Feb 2004 10:14:39 -0800</div><div class="line">From: Tutorial Guy &lt;tutorial_sender@example.com&gt;</div><div class="line">To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;</div><div class="line">Subject: Tutorate!</div><div class="line"></div><div class="line">Hello, how are you, goodbye.</div><div class="line">'''</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailFrom</span><span class="params">(self)</span>:</span></div><div class="line">        result = self.mailFrom</div><div class="line">        self.mailFrom = <span class="keyword">None</span></div><div class="line">        <span class="keyword">return</span> result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailTo</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [self.mailTo]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailData</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> StringIO.StringIO(self.mailData)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sentMail</span><span class="params">(self, code, resp, numOk, addresses, log)</span>:</span></div><div class="line">        print(<span class="string">'Sent'</span>, numOk, <span class="string">'messages'</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPClientFactory</span><span class="params">(protocol.ClientFactory)</span>:</span></div><div class="line">    protocol = SMTPTutorialClient</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.protocol(secret=<span class="keyword">None</span>, identity=<span class="string">'example.com'</span>)</div><div class="line"></div><div class="line">smtpClientFactory = SMTPClientFactory()</div><div class="line"></div><div class="line">smtpClientService = internet.TCPClient(<span class="string">'localhost'</span>, <span class="number">25</span>, smtpClientFactory)</div><div class="line">smtpClientService.setServiceParent(application)</div></pre></td></tr></table></figure>
<p>我们来剖析一下其中的四个函数：</p>
<ul>
<li><code>def getMailFrom(self):</code> 这个方法用于确定 <code>reverse-path</code>  ——也被称作发件地址。这个值被用于SMTP中的 <code>MAIL</code> 命令。这个方法必须返回符合 RFC 2821 定义的一个 <code>reverse-path</code> 。简单的说，就是它可以是i 个像”alice@example.com”这样的字符串。注意只有一个发件地址被SMTP协议所允许；</li>
<li><code>def getMailTo(self):</code> 和上一个方法差不多，返回一个或多个RFC 2821定义的 <code>forward-path</code> —— 转发地址，注意它必须包括至少一个地址，即使只有一个，它也将是一个列表（感觉这里好啰嗦）；</li>
<li><code>def getMailData(self):</code> 这个也很简单，它将会返回一个包含信息内容的文件或者类文件对象。在这里，它将返回一个StringIO因为我们已经有一个包括信息的字符窜了。假使文件内容包括多行（正如邮件通常的样子），行间应该由 <code>\n</code> 来划分（正如我们经常以“rt”模式打开文本文件）：必要的newline会由 <code>SMTPClient</code> 自动转换；</li>
<li><code>def sentMail(self, code, resp, numOk, addresses, log):</code> 这个方法和邮件发送没有太大关系，是用给twisted来提供信息传递成功与失败信息的；其中 <code>code</code> 是最终命令返回的状态码：<blockquote>
<p>For successful transactions, it will be 250. For transient failures (those which should be retried), it will be between 400 and 499, inclusive. For permanent failures (this which will never work, no matter how many times you retry them), it will be between 500 and 599.  </p>
</blockquote>
</li>
</ul>
<figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient<span class="string">-7</span>.tac</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [-] Loading smtpclient<span class="string">-7</span>.tac...</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [-] Loaded.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [__builtin__.SMTPClientFactory#info] Starting factory &lt;__builtin__.SMTPClientFactory instance at 0x10c04fa70&gt;</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [stdout#info] Sent 0 messages</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:06:32<span class="string">+0800</span> [__builtin__.SMTPClientFactory#info] Stopping factory &lt;__builtin__.SMTPClientFactory instance at 0x10c04fa70&gt;</div></pre></td></tr></table></figure>
<h3 id="第八个SMTP客户端"><a href="#第八个SMTP客户端" class="headerlink" title="第八个SMTP客户端"></a>第八个SMTP客户端</h3><p>这个版本就添加了两行代码，避免了每次发送完邮件后都要输入^C 的尴尬……</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><span class="keyword">import</span> StringIO</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> internet</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> protocol</div><div class="line"><span class="keyword">from</span> twisted.mail <span class="keyword">import</span> smtp</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPTutorialClient</span><span class="params">(smtp.ESMTPClient)</span>:</span></div><div class="line">    mailFrom = <span class="string">"tutorial_sender@example.com"</span></div><div class="line">    <span class="comment"># mailTo = "tutorial_recipient@example.net"</span></div><div class="line">    mailTo = <span class="string">"console@example.net"</span></div><div class="line">    mailData = <span class="string">'''\</span></div><div class="line">Date: Fri, 6 Feb 2004 10:14:39 -0800</div><div class="line">From: Tutorial Guy &lt;tutorial_sender@example.com&gt;</div><div class="line">To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;</div><div class="line">Subject: Tutorate!</div><div class="line"></div><div class="line">Hello, how are you, goodbye.</div><div class="line">'''</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailFrom</span><span class="params">(self)</span>:</span></div><div class="line">        result = self.mailFrom</div><div class="line">        self.mailFrom = <span class="keyword">None</span></div><div class="line">        <span class="keyword">return</span> result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailTo</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [self.mailTo]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailData</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> StringIO.StringIO(self.mailData)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sentMail</span><span class="params">(self, code, resp, numOk, addresses, log)</span>:</span></div><div class="line">        print(<span class="string">'Sent'</span>, numOk, <span class="string">'messages'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</div><div class="line">        reactor.stop()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPClientFactory</span><span class="params">(protocol.ClientFactory)</span>:</span></div><div class="line">    protocol = SMTPTutorialClient</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.protocol(secret=<span class="keyword">None</span>, identity=<span class="string">'example.com'</span>)</div><div class="line"></div><div class="line">smtpClientFactory = SMTPClientFactory()</div><div class="line"></div><div class="line">smtpClientService = internet.TCPClient(<span class="string">'localhost'</span>, <span class="number">25</span>, smtpClientFactory)</div><div class="line">smtpClientService.setServiceParent(application)</div></pre></td></tr></table></figure>
<p>stop作为reactor的一个方法，是退出twisted事件循环的重要函数。（关于对twisted异步编程的机制，在过段时间对twisted有了更深入的理解后会总结成一篇博文。）</p>
<p>运行：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">❯ twistd -ny smtpclient<span class="string">-8</span>.tac</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [-] Loading smtpclient<span class="string">-8</span>.tac...</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [-] Loaded.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] twistd 16.5.0 (/usr/local/opt/python/bin/python2.7 2.7.12) starting up.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] reactor class: twisted.internet.selectreactor.SelectReactor.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [__builtin__.SMTPClientFactory#info] Starting factory &lt;__builtin__.SMTPClientFactory instance at 0x10213ca70&gt;</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [stdout#info] Sent 0 messages</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [__builtin__.SMTPClientFactory#info] Stopping factory &lt;__builtin__.SMTPClientFactory instance at 0x10213ca70&gt;</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [-] Main loop terminated.</div><div class="line">2016<span class="string">-11</span><span class="string">-12</span>T20:55:58<span class="string">+0800</span> [twisted.scripts._twistd_unix.UnixAppLogger#info] Server Shut Down.</div></pre></td></tr></table></figure></p>
<h3 id="第九个SMTP客户端"><a href="#第九个SMTP客户端" class="headerlink" title="第九个SMTP客户端"></a>第九个SMTP客户端</h3><p>还存在一个遗留任务让这个tutorial SMTP变完整：相对总是通过知名主机寄送邮件，我们还会查询邮件交换服务器来寻找收件人的地址并且尝试递交信息给那个主机。</p>
<p>在这个版本，我们先是通过定义一个函数来完成这个特性</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMailExchange</span><span class="params">(host)</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'localhost'</span></div></pre></td></tr></table></figure>
<p>很明显这并没有返回正确的邮件交换主机（实际上，它返回我们现在一直使用的主机），但是它给出了决定连接哪个主机的逻辑。我们用它来构造新的TCPClient服务：</p>
<figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">smtpClientService</span> = internet.TCPClient(</div><div class="line">    getMailExchange(<span class="string">'example.net'</span>), 25, smtpClientFactory)</div></pre></td></tr></table></figure>
<p>下个版本我们会扩充 <code>getMailExchange</code> 的定义。</p>
<h3 id="第十个SMTP客户端"><a href="#第十个SMTP客户端" class="headerlink" title="第十个SMTP客户端"></a>第十个SMTP客户端</h3><p>对一个特定的域名确定一个邮件交换主机需要包括网络交通（特别的，一些DNS请求）。则可能要花一个非常长的时间，所以我们介绍 <code>Deferred</code> 来表示 <code>getMailExchange</code> 的返回结果，修改函数为：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMailExchange</span><span class="params">(host)</span>:</span></div><div class="line">    <span class="keyword">return</span> defer.succeed(<span class="string">'localhost'</span>)</div></pre></td></tr></table></figure>
<p><code>defer.succeed</code> 用已经存在的结果创建一个新的 <code>Deferred</code> 对象，现在我需要调整TCPClient来构造能够期望并且恰当处理这个 <code>Deferred</code> 代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cbMailExchange</span><span class="params">(exchange)</span>:</span></div><div class="line">    smtpClientFactory = SMTPClientFactory()</div><div class="line"></div><div class="line">    smtpClientService = internet.TCPClient(exchange, <span class="number">25</span>, smtpClientFactory)</div><div class="line">    smtpClientService.setServiceParent(application)</div><div class="line"></div><div class="line">getMailExchange(<span class="string">'example.net'</span>).addCallback(cbMailExchange)</div></pre></td></tr></table></figure>
<p>深入了解 <code>Deferred</code> 已经超出了本文档的范畴，访问这里获得更多信息 <a href="https://twistedmatrix.com/documents/current/core/howto/defer.html" target="_blank" rel="external">Deferred Reference — Twisted 16.5.0 documentation</a> </p>
<h3 id="第十一个SMTP客户端"><a href="#第十一个SMTP客户端" class="headerlink" title="第十一个SMTP客户端"></a>第十一个SMTP客户端</h3><p>我们已经准备好对邮件交换的查询。现在我们将defer换成真正的查找函数—— <code>twisted.mail.relaymanager.MXCalculator</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMailExchange</span><span class="params">(host)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cbMX</span><span class="params">(mxRecord)</span>:</span></div><div class="line">        <span class="keyword">return</span> str(mxRecord.name)</div><div class="line">    <span class="keyword">return</span> relaymanager.MXCalculator().getMX(host).addCallback(cbMX)</div></pre></td></tr></table></figure>
<p>因为getMX返回Record_MX对象而不是string对象，在返回之前我们再多做一些预处理。现在我们完成了这个tutorial  SMTP客户端，它能够：</p>
<ul>
<li>look up the mail exchange host for the recipient domain</li>
<li>connect to it</li>
<li>complete an SMTP transaction</li>
<li>report its results</li>
<li>finally shut down the reacto</li>
</ul>
<p>最终版本：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</div><div class="line"><span class="keyword">import</span> StringIO</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> service</div><div class="line"></div><div class="line">application = service.Application(<span class="string">"SMTP Client Tutorial"</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> twisted.application <span class="keyword">import</span> internet</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> protocol</div><div class="line"><span class="keyword">from</span> twisted.internet <span class="keyword">import</span> defer</div><div class="line"><span class="keyword">from</span> twisted.mail <span class="keyword">import</span> smtp, relaymanager</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPTutorialClient</span><span class="params">(smtp.ESMTPClient)</span>:</span></div><div class="line">    mailFrom = <span class="string">"tutorial_sender@example.com"</span></div><div class="line">    mailTo = <span class="string">"tutorial_recipient@example.net"</span></div><div class="line">    mailData = <span class="string">'''\</span></div><div class="line">Date: Fri, 6 Feb 2004 10:14:39 -0800</div><div class="line">From: Tutorial Guy &lt;tutorial_sender@example.com&gt;</div><div class="line">To: Tutorial Gal &lt;tutorial_recipient@example.net&gt;</div><div class="line">Subject: Tutorate!</div><div class="line"></div><div class="line">Hello, how are you, goodbye.</div><div class="line">'''</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailFrom</span><span class="params">(self)</span>:</span></div><div class="line">        result = self.mailFrom</div><div class="line">        self.mailFrom = <span class="keyword">None</span></div><div class="line">        <span class="keyword">return</span> result</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailTo</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [self.mailTo]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getMailData</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> StringIO.StringIO(self.mailData)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sentMail</span><span class="params">(self, code, resp, numOk, addresses, log)</span>:</span></div><div class="line">        print(<span class="string">'Sent'</span>, numOk, <span class="string">'messages'</span>)</div><div class="line"></div><div class="line">        <span class="keyword">from</span> twisted.internet <span class="keyword">import</span> reactor</div><div class="line">        reactor.stop()</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SMTPClientFactory</span><span class="params">(protocol.ClientFactory)</span>:</span></div><div class="line">    protocol = SMTPTutorialClient</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buildProtocol</span><span class="params">(self, addr)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.protocol(secret=<span class="keyword">None</span>, identity=<span class="string">'example.com'</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getMailExchange</span><span class="params">(host)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">cbMX</span><span class="params">(mxRecord)</span>:</span></div><div class="line">        <span class="keyword">return</span> str(mxRecord.name)</div><div class="line">    <span class="keyword">return</span> relaymanager.MXCalculator().getMX(host).addCallback(cbMX)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">cbMailExchange</span><span class="params">(exchange)</span>:</span></div><div class="line">    smtpClientFactory = SMTPClientFactory()</div><div class="line"></div><div class="line">    smtpClientService = internet.TCPClient(exchange, <span class="number">25</span>, smtpClientFactory)</div><div class="line">    smtpClientService.setServiceParent(application)</div><div class="line"></div><div class="line">getMailExchange(<span class="string">'example.net'</span>).addCallback(cbMailExchange)</div></pre></td></tr></table></figure>

      
    </div>
    <div class="article-info article-info-index">
      
      <a href="/2016/11/13/译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch/" class="archive-article-date">
  	<time datetime="2016-11-12T17:21:12.000Z" itemprop="datePublished"><i class="icon-clock"></i>2016-11-13</time>
</a>
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags"></i>
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Network/">Network</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/TLDR/">TLDR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/python/">python</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/twisted/">twisted</a></li></ul>
	</div>

      
	<div class="article-category tagcloud">
	<i class="icon-price-tags"></i>
	<a class="article-category-link" href="/categories/Tech/">Tech</a>
	</div>


      <div class="clearfix"></div>
    </div>
  </div>
</article>

  
<nav id="article-nav">
  
  
    <a href="/2016/09/21/【Mac】Terminal改造小记/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">【Mac】Terminal改造小记</div>
      <i class="icon-circle-right"></i>
    </a>
  
</nav>




<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
	    <a class="jiathis_button_twitter"></a>
	    <a class="jiathis_button_plus"></a> 
	    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch" data-title="[译]Twisted Mail Tutorial: Building an SMTP Client from Scratch" data-url="http://xmhtest.space/2016/11/13/译-Twisted-Mail-Tutorial-Building-an-SMTP-Client-from-Scratch/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"xmhtech"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>





      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Minghao Xie
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		root: "/"
	}
</script>

<script src="/main.js"></script>





<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


    
<div class="tools-col">
  <ul class="btn-wrap">
    
      <li class="chose" data-hook="tools-section-all"><span class="text">全部</span><i class="icon-book"></i></li>
    
    
      <li data-hook="tools-section-tag"><span class="text">标签</span><i class="icon-price-tags"></i></li>
    
    
      <li data-hook="tools-section-friends"><span class="text">友链</span><i class="icon-link"></i></li>
    
    
      <li data-hook="tools-section-me"><span class="text">我</span><i class="icon-smile"></i></li>
    
  </ul>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all chose">
    	</section>
    

    
    	<section class="tools-section tools-section-tag">
    			<div class="widget tagcloud" id="js-tagcloud">
    				<a href="/tags/AI/" style="font-size: 20px;">AI</a> <a href="/tags/Concurrency/" style="font-size: 10px;">Concurrency</a> <a href="/tags/Google/" style="font-size: 10px;">Google</a> <a href="/tags/Network/" style="font-size: 13.33px;">Network</a> <a href="/tags/OS/" style="font-size: 10px;">OS</a> <a href="/tags/OpenWrt/" style="font-size: 10px;">OpenWrt</a> <a href="/tags/Prolog/" style="font-size: 20px;">Prolog</a> <a href="/tags/Resource/" style="font-size: 13.33px;">Resource</a> <a href="/tags/SDN/" style="font-size: 10px;">SDN</a> <a href="/tags/TLDR/" style="font-size: 10px;">TLDR</a> <a href="/tags/Translation/" style="font-size: 10px;">Translation</a> <a href="/tags/VM/" style="font-size: 10px;">VM</a> <a href="/tags/book/" style="font-size: 10px;">book</a> <a href="/tags/c/" style="font-size: 10px;">c++</a> <a href="/tags/develop/" style="font-size: 13.33px;">develop</a> <a href="/tags/info/" style="font-size: 16.67px;">info</a> <a href="/tags/language/" style="font-size: 20px;">language</a> <a href="/tags/mac/" style="font-size: 13.33px;">mac</a> <a href="/tags/python/" style="font-size: 10px;">python</a> <a href="/tags/router/" style="font-size: 10px;">router</a> <a href="/tags/summary/" style="font-size: 10px;">summary</a> <a href="/tags/tool/" style="font-size: 13.33px;">tool</a> <a href="/tags/twisted/" style="font-size: 10px;">twisted</a> <a href="/tags/web/" style="font-size: 10px;">web</a>
    			</div>
    	</section>
    

    
    	<section class="tools-section tools-section-friends">
  		
  			<div class="friends-wrap" id="js-friends">
  			
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租1</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租2</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租3</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租4</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租5</a>
  	        
  	          <a target="_blank" class="main-nav-link switch-friends-link" href="http://xmhtest.space/">广告位招租6</a>
  	        
  	        </div>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">四川大学&lt;br&gt;&lt;br&gt;2014级&lt;br&gt;计算机科学专业&lt;br&gt;在读</div>
  	  	
    	</section>
    
  </div>
  
</div>
  </div>
</body>
</html>